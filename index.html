<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.css' rel='stylesheet' />
	<link href="css/ryht-internal-style.css" rel="stylesheet">
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:80%; }
        #controls { float: right; clear: left; width: 20%; }
		.mapboxgl-popup {
		max-width: 400px;
		font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
}
</style>
	<script>
		function showHideLayer(layerName) {
			var visibility = map.getLayoutProperty(layerName, 'visibility');
			console.log(layerName, visibility);
        if (visibility === 'visible') {
            map.setLayoutProperty(layerName, 'visibility', 'none');
            this.className = '';
        } else {
            this.className = 'active';
            map.setLayoutProperty(layerName, 'visibility', 'visible');
        }
		}


		function runWhenLoadComplete() {
			if (!map.loaded()) {
				setTimeout(runWhenLoadComplete, 100);
			}
			else {
				populateZoomControl("school-districts-control", "texas-school-districts", "NAME", "Texas School Districts");
				populateZoomControl("house-districts-control", "state-house-districts", "District", "State House Districts");
				populateZoomControl("senate-districts-control", "state-senate-districts", "District", "State Senate Districts");
			}
		}

		function populateZoomControl(selectID, sourceID, fieldName, layerName) {
			polygonNames = getIDsList(sourceID, fieldName);
			var select = document.getElementById(selectID);
			select.options[0] = new Option(layerName);
			for (i in polygonNames) {
				select.options[select.options.length] = new Option(polygonNames[i], polygonNames[i]);
			}
		}

		function getIDsList(sourceID, fieldName) {
			layerID = map.getSource(sourceID).vectorLayerIds[0];
			features = map.querySourceFeatures(sourceID, {'sourceLayer': layerID})
			featureNames = []
			for (i in features) {
				featureName = features[i].properties[fieldName]
				if (typeof featureName !== undefined) {
					if (featureNames.indexOf(featureName) < 0) {
						featureNames.push(featureName);
					}
				}
			}
			// if the IDs are numeric we have to make sure they get sorted as numbers not as text
			if (typeof featureNames[0] !== undefined && !isNaN(parseFloat(featureNames[0])) && isFinite(featureNames[0])) {
				return featureNames.sort(function(a, b){return a-b});
			}
			else { return featureNames.sort(); }
		}

		function zoomToPolygon(sourceID, itemID, fieldName) {
			// first quickly zoom out to the full layer area
			map.fitBounds(map.getSource(sourceID).bounds, options={duration: 0});
			// if we haven't passed in an itemID, then just stop there; otherwise continue with the zoom in
			if (typeof itemID !== 'undefined') {
				// use a timeout here to make sure that the zoom in doesn't try to start before the zoom out has finished
				setTimeout(
					function(){
						layerBounds = map.getSource(sourceID).bounds;
						layerID = map.getSource(sourceID).vectorLayerIds[0];
						features = map.querySourceFeatures(sourceID, {'sourceLayer': layerID})
						minX = layerBounds[2];
						maxX = layerBounds[0];
						minY = layerBounds[3];
						maxY = layerBounds[1];
						// then step through features - first to find the item we want
						for (i in features) {
							if (features[i].properties[fieldName] == itemID) {
								coords = features[i].toJSON().geometry.coordinates;
								for (j in coords) {
									// then the coords returned may be a simple array of coords, or an array of arrays if it's a multipolygon
									for (k in coords[j]) {
										if (!(coords[j][k][0] instanceof Array)) {
											if (coords[j][k][0] < minX) { minX = coords[j][k][0]; }
											if (coords[j][k][0] > maxX) { maxX = coords[j][k][0]; }
											if (coords[j][k][1] < minY) { minY = coords[j][k][1]; }
											if (coords[j][k][1] > maxY) { maxY = coords[j][k][1]; }
										}
										else {
											for (l in coords[j][k]) {
												if (coords[j][k][l][0] < minX) { minX = coords[j][k][l][0]; }
												if (coords[j][k][l][0] > maxX) { maxX = coords[j][k][l][0]; }
												if (coords[j][k][l][1] < minY) { minY = coords[j][k][l][1]; }
												if (coords[j][k][l][1] > maxY) { maxY = coords[j][k][l][1]; }
											}
										}
									}
								}
							}
						}
						// having found the bounds, the rest is easy
						map.fitBounds([[minX, minY], [maxX, maxY]], options={padding: 10});
					},
					100
				); // end of setTimeout block
			}
		}
	</script>
</head>
<body>

<div id='map'></div>

<div id='controls'>

	<h3>Click on an item to zoom to it</h3>
	<ul>
		<li onClick="map.fitBounds(map.getSource('raising-texas-teachers').bounds);">Raising Texas Teachers points</li>
		<li onClick="zoomToPolygon('texas-school-districts');">Texas School Districts (all)</li>
		<li onClick="zoomToPolygon('state-house-districts');">State House Districts (all)</li>
		<li onClick="zoomToPolygon('state-senate-districts');">State Senate Districts (all)</li>
		<li onClick="zoomToPolygon('state-senate-districts', 1);">State Senate District 1</li>
	</ul>

	<h3>Auto-populated lists</h3>
	<select id="school-districts-control" onchange="zoomToPolygon('texas-school-districts', this.value, 'NAME');"></select>
	<select id="house-districts-control" onchange="zoomToPolygon('state-house-districts', this.value, 'District');"></select>
	<select id="senate-districts-control" onchange="zoomToPolygon('state-senate-districts', this.value, 'District');"></select>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiY29yZS1naXMiLCJhIjoiaUxqQS1zQSJ9.mDT5nb8l_dWIHzbnOTebcQ';

//set bounds to Texas
var bounds = [
		[-114.9594,21.637], // southwest coords
		[-85.50,39.317] // northeast coords
	];

var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/core-gis/cjbcz8eyg70il2snv8ccgahf7', // stylesheet location; this is the style with markers turned OFF
    center: [-98.887939,31.821565], // starting position [lng, lat]
    zoom: 5.5, // starting zoom
	maxBounds:  bounds // sets bounds as max

});

map.on('load', function () {
        map.addSource('raising-blended-learners', {
        type: 'vector',
        url: 'mapbox://core-gis.cyvv2xc0'
    });
    map.addLayer({
        'id': 'raising-blended-learners-points',
        'type': 'symbol',
        'source': 'raising-blended-learners',
        'layout': {
            'visibility': 'visible'
        },
        layout: {
		  'icon-image': 'raising_blended_learners_v2',
		  'icon-allow-overlap': true,
		  },
		'source-layer': 'raising_blended_learners_v1-c9zny7'
    });


	map.addSource('raising-family-partnerships', {
        type: 'vector',
        url: 'mapbox://core-gis.20b66ic6'
    });
    map.addLayer({
        'id': 'raising-family-partnerships-points',
        'type': 'symbol',
        'source': 'raising-family-partnerships',
        layout: {
		  'icon-image': 'raising_family_partnerships_v2',
		  'icon-allow-overlap': true,
		  },
        'source-layer': 'raising_family_partnerships_v-66401r'
    });

	map.addSource('raising-texas-teachers', {
        type: 'vector',
        url: 'mapbox://core-gis.bev3k3sc'
    });
    map.addLayer({
        'id': 'raising-texas-teachers-points',
        'type': 'symbol',
        'source': 'raising-texas-teachers',
        'layout': {
            'visibility': 'visible'
        },
        layout: {
		  'icon-image': 'raising_texas_teachers_v2',
		  'icon-allow-overlap': true,
		  },
        'source-layer': 'raising_texas_teachers_v1-98thqt'
    });


	map.addSource('raising-school-leaders', {
        type: 'vector',
        url: 'mapbox://core-gis.69ngzsbu'
    });
    map.addLayer({
        'id': 'raising-school-leaders-points',
        'type': 'symbol',
        'source': 'raising-school-leaders',
        'layout': {
            'visibility': 'visible'
        },
        layout: {
		  'icon-image': 'raising_school_leaders_v2',
		  'icon-allow-overlap': true,
		  },
        'source-layer': 'raising_school_leaders_v1-7g2pj6'
    });

	map.addSource('districts-of-innovation', {
        type: 'vector',
        url: 'mapbox://core-gis.b1ufwbfk'
    });
    map.addLayer({
        'id': 'districts-of-innovation-points',
        'type': 'symbol',
        'source': 'districts-of-innovation',
        layout: {
		  'icon-image': 'districts_of_innovation_v2',
		  'icon-allow-overlap': true,
		  },
        'source-layer': 'districts_of_innovation_v1-4i92yo'
    });


	map.addSource('texas-school-districts', {
        type: 'vector',
        url: 'mapbox://core-gis.e4af0de1'
    });
    map.addLayer({
        'id': 'texas-school-districts-lines',
        'type': 'line',
        'source': 'texas-school-districts',
		'source-layer': 'texas_school_districts_v2',
        'layout': {
            'visibility': 'visible',
			'line-join': 'round',
			'line-cap': 'round'
        },
        'paint': {
            'line-color': '#c29ed7',
            'line-width': 1
        },
    });

	map.addSource('state-senate-districts', {
        type: 'vector',
        url: 'mapbox://core-gis.b2eu90mx'
    });
    map.addLayer({
        'id': 'state-senate-districts-lines',
        'type': 'line',
        'source': 'state-senate-districts',
		'source-layer': 'state_senate_districts-0g2odu',
        'layout': {
            'visibility': 'visible',
			'line-join': 'round',
			'line-cap': 'round'
        },
        'paint': {
            'line-color': 'rgba(99,108,153,0.5)',
            'line-width': 2
        },

    });


	map.addSource('state-house-districts', {
        type: 'vector',
        url: 'mapbox://core-gis.9drnaiu0'
    });
    map.addLayer({
        'id': 'state-house-districts-lines',
        'type': 'line',
        'source': 'state-house-districts',
		'source-layer': 'state_house_districts-1vl4x8',
        'layout': {
            'visibility': 'visible',
			'line-join': 'round',
			'line-cap': 'round'
        },
        'paint': {
            'line-color': 'rgba(117,137,77,0.5)',
            'line-width': 2
        },

    });


	runWhenLoadComplete();
});


// When a click event occurs on a feature in the states layer, open a popup at the
    // location of the click, with description HTML from its properties.
    map.on('click', 'raising_blended_learners_points', function (e) {
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(fillpopup(e.features[0].properties))
            .addTo(map);
		console.log(e.features[0].properties);
    });

	 // Change the cursor to a pointer when the mouse is over the points layer.
    map.on('mouseenter', 'raising_blended_learners_points', function () {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'raising_blended_learners_points', function () {
        map.getCanvas().style.cursor = '';
    });


</script>

</body>
</html>
