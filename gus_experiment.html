<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Raise Your Hand Texas Internal Web Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.css' rel='stylesheet' />
	<link href="css/ryht-internal-style.css" rel="stylesheet">
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
		.mapboxgl-popup {
		max-width: 400px;
		font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
}
</style>
	<script>
		function showHideLayer(layerName, markerName) {
			var visibility = map.getLayoutProperty(layerName, 'visibility');
//			console.log(layerName, visibility);
        if (visibility === 'visible') {
            map.setLayoutProperty(layerName, 'visibility', 'none');
            this.className = '';
			document.getElementById(markerName).classList.add('inactive');
        } else {
            this.className = 'active';
            map.setLayoutProperty(layerName, 'visibility', 'visible');
			document.getElementById(markerName).classList.remove('inactive');
        }
		}

//These are the four functions written by Eldan that power the zoom-to-district feature
// runWhenLoadComplete() checks if the map has finished loading data, and once it has then it calls the next one.
//populateZoomControl() fills the dropdowns with options generated from reading the data layers for all the district names.
//getIDsList() does the actual work of fetching the district names
//zoomToPolygon() zooms the map to the district extent

function runWhenLoadComplete() {
			if (!map.loaded()) {
				setTimeout(runWhenLoadComplete, 100);
			}
			else {
				populateZoomControl("school-districts-control", "texas-school-districts", "NAME", "Texas School Districts");
				populateZoomControl("house-districts-control", "state-house-districts", "District", "State House Districts");
				populateZoomControl("senate-districts-control", "state-senate-districts", "District", "State Senate Districts");
			}
		}

		function populateZoomControl(selectID, sourceID, fieldName, layerName) {
			polygonNames = getIDsList(sourceID, fieldName);
			var select = document.getElementById(selectID);
			select.options[0] = new Option(layerName);
			for (i in polygonNames) {
				select.options[select.options.length] = new Option(polygonNames[i], polygonNames[i]);
			}
			showHideLayer(sourceID+"-lines", sourceID.replace("-", "_").replace("-", "_"));
		}

		function getIDsList(sourceID, fieldName) {
			layerID = map.getSource(sourceID).vectorLayerIds[0];
			features = map.querySourceFeatures(sourceID, {'sourceLayer': layerID})
			featureNames = []
			for (i in features) {
				featureName = features[i].properties[fieldName]
				if (typeof featureName !== undefined) {
					if (featureNames.indexOf(featureName) < 0) {
						featureNames.push(featureName);
					}
				}
			}
			// if the IDs are numeric we have to make sure they get sorted as numbers not as text
			if (typeof featureNames[0] !== undefined && !isNaN(parseFloat(featureNames[0])) && isFinite(featureNames[0])) {
				return featureNames.sort(function(a, b){return a-b});
			}
			else { return featureNames.sort(); }
		}

		function zoomToPolygon(sourceID, itemID, fieldName) {
			// first quickly zoom out to the full layer area
			map.fitBounds(map.getSource(sourceID).bounds, options={duration: 0});
			// if we haven't passed in an itemID, then just stop there; otherwise continue with the zoom in
			if (typeof itemID !== 'undefined') {
				// use a timeout here to make sure that the zoom in doesn't try to start before the zoom out has finished
				setTimeout(
					function(){
						layerBounds = map.getSource(sourceID).bounds;
						layerID = map.getSource(sourceID).vectorLayerIds[0];
						features = map.querySourceFeatures(sourceID, {'sourceLayer': layerID})
						minX = layerBounds[2];
						maxX = layerBounds[0];
						minY = layerBounds[3];
						maxY = layerBounds[1];
						// then step through features - first to find the item we want
						for (i in features) {
							if (features[i].properties[fieldName] == itemID) {
								coords = features[i].toJSON().geometry.coordinates;
								for (j in coords) {
									// then the coords returned may be a simple array of coords, or an array of arrays if it's a multipolygon
									for (k in coords[j]) {
										if (!(coords[j][k][0] instanceof Array)) {
											if (coords[j][k][0] < minX) { minX = coords[j][k][0]; }
											if (coords[j][k][0] > maxX) { maxX = coords[j][k][0]; }
											if (coords[j][k][1] < minY) { minY = coords[j][k][1]; }
											if (coords[j][k][1] > maxY) { maxY = coords[j][k][1]; }
										}
										else {
											for (l in coords[j][k]) {
												if (coords[j][k][l][0] < minX) { minX = coords[j][k][l][0]; }
												if (coords[j][k][l][0] > maxX) { maxX = coords[j][k][l][0]; }
												if (coords[j][k][l][1] < minY) { minY = coords[j][k][l][1]; }
												if (coords[j][k][l][1] > maxY) { maxY = coords[j][k][l][1]; }
											}
										}
									}
								}
							}
						}
						// having found the bounds, the rest is easy
						map.fitBounds([[minX, minY], [maxX, maxY]], options={padding: 10});
					},
					100
				); // end of setTimeout block
			}
		}
	</script>
</head>
<body>

<!--BEGIN FLYOUT FOR 'ZOOM TO LAYERS'-->

<div id="mySidenav" class="sidenav">
	<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
	<p>
	<br><br><br>
	</p>

	<p class="moreinfo">Use the drop-down menus below to zoom to a School District, House District, or Senate District of your choice. Choose  the top entry on any drop down to return to the full extent of the state.

	<br><br>

	<!--Drop down controls-->

	<select id="school-districts-control" onchange="zoomToPolygon('texas-school-districts', this.value, 'NAME');"></select>
     <BR>
	 <BR>
	 <select id="house-districts-control" onchange="zoomToPolygon('state-house-districts', this.value, 'District');"></select>
      <BR>
	  <BR>
	  <select id="senate-districts-control" onchange="zoomToPolygon('state-senate-districts', this.value, 'District');"></select>


	<br><br>

	Map produced by <a href="http://www.coregis.net/" target="_blank">CoreGIS</a>.

	<br><br>

	<a href="https://www.raiseyourhandtexas.org/" target="_blank">Raise Your Hand Texas</a>
	<br>
    <a href="https://www.raiseyourhandtexas.org/contact/" target="_blank">Contact</a>

	</p>

</div>

<div id="main">

<div id="about">
  <span style="font-size:16px;cursor:pointer" onclick="openNav()">&#9776; Zoom to Districts</span>
</div>

<script>
function openNav() {
    document.getElementById("mySidenav").style.width = "300px";
    document.getElementById("main").style.marginLeft = "300px";
}

function closeNav() {
    document.getElementById("mySidenav").style.width = "0";
    document.getElementById("main").style.marginLeft= "0";
}
</script>

<!--END FLYOUT FOR 'ZOOM TO LAYERS'-->

<div id='map'></div>

<div class='legend'>
	<div class='legend-title'>Click on a layer name below to toggle its visibility</div>
		<div class='legend-scale'>
			  <ul class='legend-labels'>
				<li onClick="showHideLayer('raising-blended-learners-points', markerName='raising_blended_learners');"><span id="raising_blended_learners" class="inactive"></span>Raising Blended Learners</li>
				<li onClick="showHideLayer('raising-family-partnerships-points', markerName='raising_family_partnerships');"><span id="raising_family_partnerships" class="inactive"></span>Raising Family Partnerships</li>
				<li onClick="showHideLayer('charles-butt-scholars-points', markerName='charles_butt_scholars');"><span id="charles_butt_scholars" class="inactive"></span>Charles Butt Scholars</li>
				<li onClick="showHideLayer('raising-texas-teachers-points', markerName='raising_texas_teachers');"><span id="raising_texas_teachers" class="inactive"></span>Raising Texas Teachers</li>
				<li onClick="showHideLayer('raising-school-leaders-points', markerName='raising_school_leaders');"><span id="raising_school_leaders" class="inactive"></span>Raising School Leaders</li>
				<li onClick="showHideLayer('districts-of-innovation-points', markerName='districts_of_innovation');"><span id="districts_of_innovation" class="inactive"></span>Districts of Innovation</li>
				<li onClick="showHideLayer('texas-school-districts-lines', markerName='texas_school_districts');"><span id="texas_school_districts"></span>Texas School Districts</li>
				<li onClick="showHideLayer('state-house-districts-lines', markerName='state_house_districts');"><span id="state_house_districts"></span>State House Districts</li>
				<li onClick="showHideLayer('state-senate-districts-lines', markerName='state_senate_districts');"><span id="state_senate_districts"></span>State Senate Districts</li>
			  </ul>
		</div>
		<div class='legend-source'>Source: <a href="https://www.raiseyourhandtexas.org/"  target="_blank">Raise Your Hand Texas</a></div>
		<div class='map-credit'>Map design by <a href="http://www.coregis.net/"  target="_blank">CORE GIS</a></div>
	</div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiY29yZS1naXMiLCJhIjoiaUxqQS1zQSJ9.mDT5nb8l_dWIHzbnOTebcQ';

//set bounds to Texas
var bounds = [
		[-114.9594,21.637], // southwest coords
		[-85.50,39.317] // northeast coords
	];

var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/core-gis/cjbcz8eyg70il2snv8ccgahf7', // stylesheet location; this is the style with markers turned OFF
    center: [-98.887939,31.821565], // starting position [lng, lat]
    zoom: 5.5, // starting zoom
	maxBounds:  bounds // sets bounds as max

});

var originalZoomLevel = map.getZoom();
/*
var layers = map.getStyle().layers;
    // Find the index of the first symbol layer in the map style
    var firstSymbolId;
    for (var i = 0; i < layers.length; i++) {
        if (layers[i].type === 'symbol') {
            firstSymbolId = layers[i].id;
            break;
        }
    }
*/



function addPointLayer(map, gusID, sourceName, layerName, icon, legendid, visibleOnLoad) {
	gus_api(gusID, function(jsondata) {
		if ((visibleOnLoad === undefined) || (visibleOnLoad === false)) {
			var visibilityState = 'none';
			document.getElementById(legendid).classList.add('inactive');
		}	else {
			var visibilityState = 'visible';
			document.getElementById(legendid).classList.remove('inactive');
		}
		map.addSource(sourceName, {
			type: 'geojson',
			data: jsondata
		});
		map.addLayer({
			'id': layerName,
			'type': 'symbol',
			'source': sourceName,
			layout: {
				'icon-image': icon,
				'icon-size':0.1,//initial size is small, so as we 'zoom' the icon it is returning towards native resolution
				'icon-allow-overlap': true,
				'visibility': visibilityState
			}
		});
		map.on("zoomend", function(){
			map.setLayoutProperty(layerName, 'icon-size', (1 + (map.getZoom() / originalZoomLevel - 1) * 2.5)*0.1);//the rightmost number in the parentheses should be the same as the 'icon-size' value in line 261; the 2.5 value is a best guess estimate to generate the zoom behavior we want
		});
	});
}

/*
	Updated method for adding point layers using the GUS API:
	Simply call the addPointLayer() function with arguments like the examples below.  The final argument is optional: set it to true if you want the layer visible before the user does anything; otherwise it's hidden until they click to activate it.
*/

map.on('load', function () {
	addPointLayer(
		map,
		"1lW_TLQ25u20FtYMsJIrgWbGvMpdkIVfehZ2wsDa8eck", // Google Sheets ID
		'raising-family-partnerships', // this one will be the data source name
		'raising-family-partnerships-points', // layer name
		'raising_family_partnerships_large' ,// this one will be the icon image name, using the name from Mapbox
		'raising_family_partnerships' // this one will be the id in the legend
	);

	addPointLayer(
		map,
		"1zzDxER2Ef2qMmUg4Ff4zWXoPMQh1RpK4TAueCWqQixE",
		'raising-blended-learners',
		'raising-blended-learners-points',
		'raising_blended_learners_large',
		'raising_blended_learners'
	);

	addPointLayer(
		map,
		"1jlfzTbBwEZVMlkGSJLf9v50vBvHeTJKq13xLus7KbC4",
		'charles-butt-scholars',
		'charles-butt-scholars-points',
		'charles_butt_scholars_large',
		'charles_butt_scholars',
		true // set the optional final argument to true to have the layer visible on load
	);

	addPointLayer(
		map,
		"1e24TCpzxcgbSY6CaqDUn4Ll_F36Ttc9341EXEyhpsVs",
		'raising-texas-teachers',
		'raising-texas-teachers-points',
		'raising_texas_teachers_large',
		'raising_texas_teachers'
	);

	addPointLayer(
		map,
		"1MLMUvg5WXSf3CytsEzEdVPsYPYUb_2nSXsnRnD_7Lj0",
		'raising-school-leaders',
		'raising-school-leaders-points',
		'raising_school_leaders_large',
		'raising_school_leaders'
	);

	addPointLayer(
		map,
		"1F3qjOKXsK5GTfM_f8RdoQFCJiz6QWDNOQOthJOMQB2g",
		'districts-of-innovation',
		'districts-of-innovation-points',
		'districts_of_innovation_large',
		'districts_of_innovation'
	);



	map.addSource('texas-school-districts', {
        type: 'vector',
        url: 'mapbox://core-gis.e4af0de1'
    });
    map.addLayer({
        'id': 'texas-school-districts-lines',
        'type': 'line',
        'source': 'texas-school-districts',
		'source-layer': 'texas_school_districts_v2',
        'layout': {
            'visibility': 'visible',
			'line-join': 'round',
			'line-cap': 'round'
        },
        'paint': {
            'line-color': '#a1b082',
            'line-width': 1
        },
    }, 'districts-of-innovation-points');

	map.addSource('state-senate-districts', {
        type: 'vector',
        url: 'mapbox://core-gis.b2eu90mx'
    });
    map.addLayer({
        'id': 'state-senate-districts-lines',
        'type': 'line',
        'source': 'state-senate-districts',
		'source-layer': 'state_senate_districts-0g2odu',
        'layout': {
            'visibility': 'visible',
			'line-join': 'round',
			'line-cap': 'round'
        },
        'paint': {
            'line-color': '#a1b082',
            'line-width': 1
        },

    }, 'districts-of-innovation-points');

	map.addSource('school_house_senate_districts_UNION', {
        type: 'vector',
        url: 'mapbox://core-gis.a81c8ecf'
    });
    map.addLayer({
        'id': 'school_house_senate_districts_UNION-poly',
        'type': 'fill',
        'source': 'school_house_senate_districts_UNION',
		'source-layer': 'school_house_senate_districts_UNION',
         'layout': {        },
        'paint': {
            'fill-color': 'rgba(200, 100, 240, 0)',
            'fill-outline-color': 'rgba(200, 100, 240, 0)'
			},

    }, 'districts-of-innovation-points');


	map.addSource('state-house-districts', {
        type: 'vector',
        url: 'mapbox://core-gis.9drnaiu0'
    });
    map.addLayer({
        'id': 'state-house-districts-lines',
        'type': 'line',
        'source': 'state-house-districts',
		'source-layer': 'state_house_districts-1vl4x8',
        'layout': {
            'visibility': 'visible',
			'line-join': 'round',
			'line-cap': 'round'
        },
        'paint': {
            'line-color': 'rgba(117,137,77,0.5)',
            'line-width': 1
        },

    }, 'districts-of-innovation-points');


    map.addLayer({
        'id': 'state-house-districts-poly',
        'type': 'fill',
        'source': 'state-house-districts',
		'source-layer': 'state_house_districts-1vl4x8',
        'layout': {        },
        'paint': {
            'fill-color': 'rgba(200, 100, 240, 0)',
            'fill-outline-color': 'rgba(200, 100, 240, 0)'
			},

    });

	runWhenLoadComplete();

});

// This is the popup for the merged boundary layers
// When a click event occurs on a feature in the unioned districts layer, open a popup at the
// location of the click, with description HTML from its properties.
    map.on('click', 'school_house_senate_districts_UNION-poly', function (e) {
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(fillpopup(e.features[0].properties))
            .addTo(map);
//		console.log(e.features[0].properties);
    });

	 // Change the cursor to a pointer when the mouse is over the house districts layer.
    map.on('mouseenter', 'school_house_senate_districts_UNION-poly', function () {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'school_house_senate_districts_UNION-poly', function () {
        map.getCanvas().style.cursor = '';
    });

	function fillpopup(data){
		var html = "";
		html = html + "<span class='varname'>School District: </span> <span class='attribute'>" + data.SchDistNam + "</span>";
		html = html + "<br>"
		html = html + "<span class='varname'>House District: </span> <span class='attribute'>" + data.HseDistNum + "</span>";
		html = html + "<br>"
		html = html + "<span class='varname'>Senate District: </span> <span class='attribute'>" + data.SenDistNum + "</span>";
		return html;
		//this will return the string to the calling function

	}






function fetchJSONFile(path, callback) {
    var httpRequest = new XMLHttpRequest();
    httpRequest.onreadystatechange = function() {
        if (httpRequest.readyState === 4) {
            if (httpRequest.status === 200) {
                var data = JSON.parse(httpRequest.responseText);
                if (callback) callback(data);
            }
        }
    };
    httpRequest.open('GET', path);
    httpRequest.send();
}

function gus_api(id, callback) {
  const url = `https://spreadsheets.google.com/feeds/cells/${id}/od6/public/basic?alt=json`;

  fetchJSONFile(url, function(data) {

    let headers = {};
    let entries = {};

    data.feed.entry.forEach((e) => {
      // get the row number
      const row = parseInt(e.title['$t'].match(/\d+/g)[0]);
      const column = e.title['$t'].match(/[a-zA-Z]+/g)[0];
      const content = e.content['$t'];

      // it's a header
      if (row === 1) {
        headers[column] = content;
      } else {
        if (!entries[row]) entries[row] = {};
        entries[row][headers[column]] = content;
      }
    });

    const gj = { type: 'FeatureCollection', features: [] };
    for (let e in entries) {

      const feature = {
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [0, 0]
        },
        properties: entries[e]
      };

      for (let p in entries[e]) {
        switch(p) {
          case 'longitude':
          case 'LONGITUDE':
          case 'long':
          case 'LONG':
          case 'lng':
          case 'LNG':
          case 'lon':
          case 'LON':
          case 'x':
          case 'X':
            feature.geometry.coordinates[0] = parseFloat(entries[e][p]);
          case 'latitude':
          case 'LATITUDE':
          case 'lat':
          case 'LAT':
          case 'y':
          case 'Y':
            feature.geometry.coordinates[1] = parseFloat(entries[e][p]);
        }
      }

      gj.features.push(feature);
    }

//		console.log(JSON.stringify(gj));
    callback(gj);
  });
};
</script>

</body>
</html>
