<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Raise Your Hand Texas Internal Web Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.40.1/mapbox-gl.css' rel='stylesheet' />
	<link href="css/ryht-internal-style.css" rel="stylesheet">
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
		.mapboxgl-popup {
		max-width: 400px;
		font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
}
</style>
	<script>
		function showHideLayer(layerName, markerName) {
			var visibility = map.getLayoutProperty(layerName, 'visibility');
			console.log(layerName, visibility);
        if (visibility === 'visible') {
            map.setLayoutProperty(layerName, 'visibility', 'none');
            this.className = '';
			document.getElementById(markerName).classList.add('inactive');
        } else {
            this.className = 'active';
            map.setLayoutProperty(layerName, 'visibility', 'visible');
			document.getElementById(markerName).classList.remove('inactive');
        }
		}

//These are the four functions written by Eldan that power the zoom-to-district feature
// runWhenLoadComplete() checks if the map has finished loading data, and once it has then it calls the next one.
//populateZoomControl() fills the dropdowns with options generated from reading the data layers for all the district names.
//getIDsList() does the actual work of fetching the district names
//zoomToPolygon() zooms the map to the district extent

function runWhenLoadComplete() {
			if (!map.loaded()) {
				setTimeout(runWhenLoadComplete, 100);
			}
			else {
				populateZoomControl("school-districts-control", "texas-school-districts", "NAME", "Texas School Districts");
				populateZoomControl("house-districts-control", "state-house-districts", "District", "State House Districts");
				populateZoomControl("senate-districts-control", "state-senate-districts", "District", "State Senate Districts");
			}
		}

		function populateZoomControl(selectID, sourceID, fieldName, layerName) {
			polygonNames = getIDsList(sourceID, fieldName);
			var select = document.getElementById(selectID);
			select.options[0] = new Option(layerName);
			for (i in polygonNames) {
				select.options[select.options.length] = new Option(polygonNames[i], polygonNames[i]);
			}
		}

		function getIDsList(sourceID, fieldName) {
			layerID = map.getSource(sourceID).vectorLayerIds[0];
			features = map.querySourceFeatures(sourceID, {'sourceLayer': layerID})
			featureNames = []
			for (i in features) {
				featureName = features[i].properties[fieldName]
				if (typeof featureName !== undefined) {
					if (featureNames.indexOf(featureName) < 0) {
						featureNames.push(featureName);
					}
				}
			}
			// if the IDs are numeric we have to make sure they get sorted as numbers not as text
			if (typeof featureNames[0] !== undefined && !isNaN(parseFloat(featureNames[0])) && isFinite(featureNames[0])) {
				return featureNames.sort(function(a, b){return a-b});
			}
			else { return featureNames.sort(); }
		}

		function zoomToPolygon(sourceID, itemID, fieldName) {
			// first quickly zoom out to the full layer area
			map.fitBounds(map.getSource(sourceID).bounds, options={duration: 0});
			// if we haven't passed in an itemID, then just stop there; otherwise continue with the zoom in
			if (typeof itemID !== 'undefined') {
				// use a timeout here to make sure that the zoom in doesn't try to start before the zoom out has finished
				setTimeout(
					function(){
						layerBounds = map.getSource(sourceID).bounds;
						layerID = map.getSource(sourceID).vectorLayerIds[0];
						features = map.querySourceFeatures(sourceID, {'sourceLayer': layerID})
						minX = layerBounds[2];
						maxX = layerBounds[0];
						minY = layerBounds[3];
						maxY = layerBounds[1];
						// then step through features - first to find the item we want
						for (i in features) {
							if (features[i].properties[fieldName] == itemID) {
								coords = features[i].toJSON().geometry.coordinates;
								for (j in coords) {
									// then the coords returned may be a simple array of coords, or an array of arrays if it's a multipolygon
									for (k in coords[j]) {
										if (!(coords[j][k][0] instanceof Array)) {
											if (coords[j][k][0] < minX) { minX = coords[j][k][0]; }
											if (coords[j][k][0] > maxX) { maxX = coords[j][k][0]; }
											if (coords[j][k][1] < minY) { minY = coords[j][k][1]; }
											if (coords[j][k][1] > maxY) { maxY = coords[j][k][1]; }
										}
										else {
											for (l in coords[j][k]) {
												if (coords[j][k][l][0] < minX) { minX = coords[j][k][l][0]; }
												if (coords[j][k][l][0] > maxX) { maxX = coords[j][k][l][0]; }
												if (coords[j][k][l][1] < minY) { minY = coords[j][k][l][1]; }
												if (coords[j][k][l][1] > maxY) { maxY = coords[j][k][l][1]; }
											}
										}
									}
								}
							}
						}
						// having found the bounds, the rest is easy
						map.fitBounds([[minX, minY], [maxX, maxY]], options={padding: 10});
					},
					100
				); // end of setTimeout block
			}
		}
	</script>
</head>
<body>

<!--BEGIN FLYOUT FOR 'ZOOM TO LAYERS'-->

<div id="mySidenav" class="sidenav">
	<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
	<p>
	<br><br><br>
	</p>

	<p class="moreinfo">Use the drop-down menus below to zoom to a School District, House District, or Senate District of your choice. Choose  the top entry on any drop down to return to the full extent of the state.

	<br><br>

	<!--Drop down controls-->

	<select id="school-districts-control" onchange="zoomToPolygon('texas-school-districts', this.value, 'NAME');"></select>
     <BR>
	 <BR>
	 <select id="house-districts-control" onchange="zoomToPolygon('state-house-districts', this.value, 'District');"></select>
      <BR>
	  <BR>
	  <select id="senate-districts-control" onchange="zoomToPolygon('state-senate-districts', this.value, 'District');"></select>


	<br><br>

	Map produced by <a href="http://www.coregis.net/" target="_blank">CoreGIS</a>.

	<br><br>

	<a href="https://www.raiseyourhandtexas.org/" target="_blank">Raise Your Hand Texas</a>
	<br>
    <a href="https://www.raiseyourhandtexas.org/contact/" target="_blank">Contact</a>

	</p>

</div>

<div id="main">

<div id="about">
  <span style="font-size:16px;cursor:pointer" onclick="openNav()">&#9776; Zoom to Districts</span>
</div>

<script>
function openNav() {
    document.getElementById("mySidenav").style.width = "300px";
    document.getElementById("main").style.marginLeft = "300px";
}

function closeNav() {
    document.getElementById("mySidenav").style.width = "0";
    document.getElementById("main").style.marginLeft= "0";
}
</script>

<!--END FLYOUT FOR 'ZOOM TO LAYERS'-->

<div id='map'></div>

<div class='legend'>
	<div class='legend-title'>Click on a layer name below to toggle its visibility</div>
		<div class='legend-scale'>
			  <ul class='legend-labels'>
				<li onClick="showHideLayer('raising-blended-learners-points', markerName='raising_blended_learners');"><span id="raising_blended_learners"></span>Raising Blended Learners</li>
				<li onClick="showHideLayer('raising-family-partnerships-points', markerName='raising_family_partnerships');"><span id="raising_family_partnerships"></span>Raising Family Partnerships</li>
				<li onClick="showHideLayer('charles-butt-scholars-points', markerName='charles_butt_scholars');"><span id="charles_butt_scholars"></span>Charles Butt Scholars</li>	
				<li onClick="showHideLayer('raising-texas-teachers-points', markerName='raising_texas_teachers');"><span id="raising_texas_teachers"></span>Raising Texas Teachers</li>
				<li onClick="showHideLayer('raising-school-leaders-points', markerName='raising_school_leaders');"><span id="raising_school_leaders"></span>Raising School Leaders</li>
				<li onClick="showHideLayer('districts-of-innovation-points', markerName='districts_of_innovation');"><span id="districts_of_innovation"></span>Districts of Innovation</li>
				<li onClick="showHideLayer('texas-school-districts-lines', markerName='texas_school_districts');"><span id="texas_school_districts"></span>Texas School Districts</li>
				<li onClick="showHideLayer('state-house-districts-lines', markerName='state_house_districts');"><span id="state_house_districts"></span>State House Districts</li>
				<li onClick="showHideLayer('state-senate-districts-lines', markerName='state_senate_districts');"><span id="state_senate_districts"></span>State Senate Districts</li>
			  </ul>
		</div>
		<div class='legend-source'>Source: <a href="https://www.raiseyourhandtexas.org/"  target="_blank">Raise Your Hand Texas</a></div>
		<div class='map-credit'>Map design by <a href="http://www.coregis.net/"  target="_blank">CORE GIS</a></div>
	</div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiY29yZS1naXMiLCJhIjoiaUxqQS1zQSJ9.mDT5nb8l_dWIHzbnOTebcQ';

//set bounds to Texas
var bounds = [
		[-114.9594,21.637], // southwest coords
		[-85.50,39.317] // northeast coords
	];

var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/core-gis/cjbcz8eyg70il2snv8ccgahf7', // stylesheet location; this is the style with markers turned OFF
    center: [-98.887939,31.821565], // starting position [lng, lat]
    zoom: 5.5, // starting zoom
	maxBounds:  bounds // sets bounds as max

});
/*
var layers = map.getStyle().layers;
    // Find the index of the first symbol layer in the map style
    var firstSymbolId;
    for (var i = 0; i < layers.length; i++) {
        if (layers[i].type === 'symbol') {
            firstSymbolId = layers[i].id;
            break;
        }
    }
*/


/*
	DIFFERENCES BETWEEN HOW WE EMBED A GOOGLE SHEET VS A MAPBOX LAYER
	1. start by calling the gus_api() function with two arguments.  The first is the ID for the sheet you want to read in, and the second is an anonymous function that will contain the map.addSource() and map.addLayer() calls that depend on this data.  Like this:
		gus_api("IDstringfromgoogle", function(jsondata) {addSource and addLayer calls go inside these curly braces});
	2. in the map.addSource() call, change type to 'geojson', and replace the url line with:
		data: jsondata
	3. remove the source-layer argument from map.addLayer()
	4. remove the final, unnamed argument from map.addLayer() (the one that specifies which layer to put this one before)
	5. it _might_ be necessary to also remove the 'before' arguments from the layers that specify district boundaries, because there is a slight delay associated with loading from google sheets, which in turn means that Mapbox GL JS complains that the layer you're trying to go behind doesn't exist [yet].  If this turns out to be a problem, we should be able to remedy it by putting a set of map.moveLayer() calls (see https://www.mapbox.com/mapbox-gl-js/api/#map#movelayer ) in the runWhenLoadComplete() function so that they fire _after_ all the layers have been created.

	The 'raising-family-partnerships' layer definition at the top of the following map.on('load') call demonstrates #1-#4.  I've made the indentation of the 'raising-blended-learners' old-style layer definition consistent with it, so that comparing is easier.
*/



map.on('load', function () {
	gus_api("1lW_TLQ25u20FtYMsJIrgWbGvMpdkIVfehZ2wsDa8eck", function(jsondata) {
		map.addSource('raising-family-partnerships', {
			type: 'geojson',
			data: jsondata
		});
		map.addLayer({
			'id': 'raising-family-partnerships-points',
			'type': 'symbol',
			'source': 'raising-family-partnerships',
			layout: {
				'icon-image': 'raising_family_partnerships',
				'icon-allow-overlap': true,
			}
		});
	});

	
	gus_api("1zzDxER2Ef2qMmUg4Ff4zWXoPMQh1RpK4TAueCWqQixE", function(jsondata) {
		map.addSource('raising-blended-learners', {
			type: 'geojson',
			data: jsondata
		});
		map.addLayer({
			'id': 'raising-blended-learners-points',
			'type': 'symbol',
			'source': 'raising-blended-learners',
			layout: {
				'icon-image': 'raising_blended_learners',
				'icon-allow-overlap': true,
			}
		});
	});
	
	gus_api("1jlfzTbBwEZVMlkGSJLf9v50vBvHeTJKq13xLus7KbC4", function(jsondata) {
		map.addSource('charles-butt-scholars', {
			type: 'geojson',
			data: jsondata
		});
		map.addLayer({
			'id': 'charles-butt-scholars-points',
			'type': 'symbol',
			'source': 'charles-butt-scholars',
			layout: {
				'icon-image': 'charles_butt_scholars',
				'icon-allow-overlap': true,
			}
		});
	});	

	gus_api("1e24TCpzxcgbSY6CaqDUn4Ll_F36Ttc9341EXEyhpsVs", function(jsondata) {
		map.addSource('raising-texas-teachers', {
			type: 'geojson',
			data: jsondata
		});
		map.addLayer({
			'id': 'raising-texas-teachers-points',
			'type': 'symbol',
			'source': 'raising-texas-teachers',
			layout: {
				'icon-image': 'raising_texas_teachers',
				'icon-allow-overlap': true,
			}
		});
	});		

	gus_api("1MLMUvg5WXSf3CytsEzEdVPsYPYUb_2nSXsnRnD_7Lj0", function(jsondata) {
		map.addSource('raising-school-leaders', {
			type: 'geojson',
			data: jsondata
		});
		map.addLayer({
			'id': 'raising-school-leaders-points',
			'type': 'symbol',
			'source': 'raising-school-leaders',
			layout: {
				/*the icon-image is pulling the icon from the Mapbox style referenced above in the var map*/
				'icon-image': 'raising_school_leaders',
				'icon-allow-overlap': true,
			}
		});
	});

	gus_api("1F3qjOKXsK5GTfM_f8RdoQFCJiz6QWDNOQOthJOMQB2g", function(jsondata) {
		map.addSource('districts-of-innovation', {
			type: 'geojson',
			data: jsondata
		});
		map.addLayer({
			'id': 'districts-of-innovation-points',
			'type': 'symbol',
			'source': 'districts-of-innovation',
			layout: {
				'icon-image': 'districts_of_innovation',
				'icon-allow-overlap': true,
			}
		});
	});	

	
	/*
	map.addSource('raising-blended-learners', {
		type: 'vector',
		url: 'mapbox://core-gis.cyvv2xc0'
	});
	map.addLayer({
		'id': 'raising-blended-learners-points',
		'type': 'symbol',
		'source': 'raising-blended-learners',
		'layout': {
			'visibility': 'visible'
		},
		layout: {
			'icon-image': 'raising_blended_learners_v2',
			'icon-allow-overlap': true,
		},
		'source-layer': 'raising_blended_learners_v1-c9zny7'
	}, 'place-town');

*/

/*
	map.addSource('raising-texas-teachers', {
        type: 'vector',
        url: 'mapbox://core-gis.bev3k3sc'
    });
    map.addLayer({
        'id': 'raising-texas-teachers-points',
        'type': 'symbol',
        'source': 'raising-texas-teachers',
        'layout': {
            'visibility': 'visible'
        },
        layout: {
		  'icon-image': 'raising_texas_teachers_v2',
		  'icon-allow-overlap': true,
		  },
        'source-layer': 'raising_texas_teachers_v1-98thqt'
    }, 'raising-family-partnerships-points');
*/

/*
	map.addSource('raising-school-leaders', {
        type: 'vector',
        url: 'mapbox://core-gis.69ngzsbu'
    });
    map.addLayer({
        'id': 'raising-school-leaders-points',
        'type': 'symbol',
        'source': 'raising-school-leaders',
        'layout': {
            'visibility': 'visible'
        },
        layout: {
		  'icon-image': 'raising_school_leaders_v2',
		  'icon-allow-overlap': true,
		  },
        'source-layer': 'raising_school_leaders_v1-7g2pj6'
    }, 'raising-texas-teachers-points');
*/

/*
	map.addSource('districts-of-innovation', {
        type: 'vector',
        url: 'mapbox://core-gis.b1ufwbfk'
    });
    map.addLayer({
        'id': 'districts-of-innovation-points',
        'type': 'symbol',
        'source': 'districts-of-innovation',
        layout: {
		  'icon-image': 'districts_of_innovation_v2',
		  'icon-allow-overlap': true,
		  },
        'source-layer': 'districts_of_innovation_v1-4i92yo'
    },'raising-school-leaders-points');

*/

	map.addSource('texas-school-districts', {
        type: 'vector',
        url: 'mapbox://core-gis.e4af0de1'
    });
    map.addLayer({
        'id': 'texas-school-districts-lines',
        'type': 'line',
        'source': 'texas-school-districts',
		'source-layer': 'texas_school_districts_v2',
        'layout': {
            'visibility': 'visible',
			'line-join': 'round',
			'line-cap': 'round'
        },
        'paint': {
            'line-color': '#c29ed7',
            'line-width': 1
        },
    }, 'districts-of-innovation-points');

	map.addSource('state-senate-districts', {
        type: 'vector',
        url: 'mapbox://core-gis.b2eu90mx'
    });
    map.addLayer({
        'id': 'state-senate-districts-lines',
        'type': 'line',
        'source': 'state-senate-districts',
		'source-layer': 'state_senate_districts-0g2odu',
        'layout': {
            'visibility': 'visible',
			'line-join': 'round',
			'line-cap': 'round'
        },
        'paint': {
            'line-color': 'rgba(99,108,153,0.5)',
            'line-width': 2
        },

    }, 'districts-of-innovation-points');

	map.addSource('school_house_senate_districts_UNION', {
        type: 'vector',
        url: 'mapbox://core-gis.a81c8ecf'
    });
    map.addLayer({
        'id': 'school_house_senate_districts_UNION-poly',
        'type': 'fill',
        'source': 'school_house_senate_districts_UNION',
		'source-layer': 'school_house_senate_districts_UNION',
         'layout': {        },
        'paint': {
            'fill-color': 'rgba(200, 100, 240, 0)',
            'fill-outline-color': 'rgba(200, 100, 240, 0)'
			},

    }, 'districts-of-innovation-points');


	map.addSource('state-house-districts', {
        type: 'vector',
        url: 'mapbox://core-gis.9drnaiu0'
    });
    map.addLayer({
        'id': 'state-house-districts-lines',
        'type': 'line',
        'source': 'state-house-districts',
		'source-layer': 'state_house_districts-1vl4x8',
        'layout': {
            'visibility': 'visible',
			'line-join': 'round',
			'line-cap': 'round'
        },
        'paint': {
            'line-color': 'rgba(117,137,77,0.5)',
            'line-width': 2
        },

    }, 'districts-of-innovation-points');


    map.addLayer({
        'id': 'state-house-districts-poly',
        'type': 'fill',
        'source': 'state-house-districts',
		'source-layer': 'state_house_districts-1vl4x8',
        'layout': {        },
        'paint': {
            'fill-color': 'rgba(200, 100, 240, 0)',
            'fill-outline-color': 'rgba(200, 100, 240, 0)'
			},

    });

	runWhenLoadComplete();

});

// This is the popup for the merged boundary layers
// When a click event occurs on a feature in the unioned districts layer, open a popup at the
// location of the click, with description HTML from its properties.
    map.on('click', 'school_house_senate_districts_UNION-poly', function (e) {
        new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(fillpopup(e.features[0].properties))
            .addTo(map);
		console.log(e.features[0].properties);
    });

	 // Change the cursor to a pointer when the mouse is over the house districts layer.
    map.on('mouseenter', 'school_house_senate_districts_UNION-poly', function () {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'school_house_senate_districts_UNION-poly', function () {
        map.getCanvas().style.cursor = '';
    });

	function fillpopup(data){
		var html = "";
		html = html + "<span class='varname'>School District: </span> <span class='attribute'>" + data.SchDistNam + "</span>";
		html = html + "<br>"
		html = html + "<span class='varname'>House District: </span> <span class='attribute'>" + data.HseDistNum + "</span>";
		html = html + "<br>"
		html = html + "<span class='varname'>Senate District: </span> <span class='attribute'>" + data.SenDistNum + "</span>";
		return html;
		//this will return the string to the calling function

	}






function fetchJSONFile(path, callback) {
    var httpRequest = new XMLHttpRequest();
    httpRequest.onreadystatechange = function() {
        if (httpRequest.readyState === 4) {
            if (httpRequest.status === 200) {
                var data = JSON.parse(httpRequest.responseText);
                if (callback) callback(data);
            }
        }
    };
    httpRequest.open('GET', path);
    httpRequest.send();
}

function gus_api(id, callback) {
  const url = `https://spreadsheets.google.com/feeds/cells/${id}/od6/public/basic?alt=json`;

  fetchJSONFile(url, function(data) {

    let headers = {};
    let entries = {};

    data.feed.entry.forEach((e) => {
      // get the row number
      const row = parseInt(e.title['$t'].match(/\d+/g)[0]);
      const column = e.title['$t'].match(/[a-zA-Z]+/g)[0];
      const content = e.content['$t'];

      // it's a header
      if (row === 1) {
        headers[column] = content;
      } else {
        if (!entries[row]) entries[row] = {};
        entries[row][headers[column]] = content;
      }
    });

    const gj = { type: 'FeatureCollection', features: [] };
    for (let e in entries) {

      const feature = {
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [0, 0]
        },
        properties: entries[e]
      };

      for (let p in entries[e]) {
        switch(p) {
          case 'longitude':
          case 'LONGITUDE':
          case 'long':
          case 'LONG':
          case 'lng':
          case 'LNG':
          case 'lon':
          case 'LON':
          case 'x':
          case 'X':
            feature.geometry.coordinates[0] = parseFloat(entries[e][p]);
          case 'latitude':
          case 'LATITUDE':
          case 'lat':
          case 'LAT':
          case 'y':
          case 'Y':
            feature.geometry.coordinates[1] = parseFloat(entries[e][p]);
        }
      }

      gj.features.push(feature);
    }

//		console.log(JSON.stringify(gj));
    callback(gj);
  });
};
</script>

</body>
</html>
